{% extends "base.html" %}

{% block title %}Baseline Assessment - NeuroBeat{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header text-center">
                <h4 class="card-title mb-0">
                    <i data-feather="clipboard" class="me-2"></i>
                    Baseline Assessment
                </h4>
                <p class="text-muted mb-0">Establish baseline measurements for personalized therapy</p>
            </div>
            <div class="card-body">
                <!-- Assessment Type Selection -->
                <div class="mb-4">
                    <!-- Check if we have stroke patients to determine which assessments to show -->
                    {% set is_stroke_focus = patients and patients|selectattr('condition', 'equalto', 'stroke')|list|length > 0 %}

                    {% if is_stroke_focus %}
                    <!-- Stroke-specific assessments only: gait, upper_limb, melodic, speech -->
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="card assessment-card border-primary" data-assessment="gait">
                                <div class="card-body text-center position-relative">
                                    <div class="assessment-status" style="display: none;">
                                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-success">
                                            <i data-feather="check" style="width: 12px; height: 12px;"></i>
                                        </span>
                                    </div>
                                    <i data-feather="activity" class="mb-3" style="width: 48px; height: 48px;"></i>
                                    <h5>Gait Assessment</h5>
                                    <p class="text-muted small">Walking rhythm and cadence</p>
                                    <span class="badge bg-info">Stroke Rehabilitation</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card assessment-card border-primary" data-assessment="upper_limb">
                                <div class="card-body text-center position-relative">
                                    <div class="assessment-status" style="display: none;">
                                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-success">
                                            <i data-feather="check" style="width: 12px; height: 12px;"></i>
                                        </span>
                                    </div>
                                    <i data-feather="hand" class="mb-3" style="width: 48px; height: 48px;"></i>
                                    <h5>Upper Limb Assessment</h5>
                                    <p class="text-muted small">Arm and hand motor function</p>
                                    <span class="badge bg-info">Stroke Rehabilitation</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card assessment-card border-primary" data-assessment="melodic">
                                <div class="card-body text-center position-relative">
                                    <div class="assessment-status" style="display: none;">
                                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-success">
                                            <i data-feather="check" style="width: 12px; height: 12px;"></i>
                                        </span>
                                    </div>
                                    <i data-feather="music" class="mb-3" style="width: 48px; height: 48px;"></i>
                                    <h5>Melodic Intonation Assessment</h5>
                                    <p class="text-muted small">Musical pattern recognition</p>
                                    <span class="badge bg-info">Stroke Rehabilitation</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card assessment-card border-primary" data-assessment="speech">
                                <div class="card-body text-center position-relative">
                                    <div class="assessment-status" style="display: none;">
                                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-success">
                                            <i data-feather="check" style="width: 12px; height: 12px;"></i>
                                        </span>
                                    </div>
                                    <i data-feather="mic" class="mb-3" style="width: 48px; height: 48px;"></i>
                                    <h5>Speech Assessment</h5>
                                    <p class="text-muted small">Speech clarity and articulation</p>
                                    <span class="badge bg-info">Stroke Rehabilitation</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <!-- All assessments for non-stroke or mixed patients -->
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="card assessment-card border-primary" data-assessment="gait">
                                <div class="card-body text-center position-relative">
                                    <div class="assessment-status" style="display: none;">
                                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-success">
                                            <i data-feather="check" style="width: 12px; height: 12px;"></i>
                                        </span>
                                    </div>
                                    <i data-feather="activity" class="mb-3" style="width: 48px; height: 48px;"></i>
                                    <h5>Gait Assessment</h5>
                                    <p class="text-muted small">Measure walking cadence and rhythm</p>
                                    <span class="badge bg-primary">All Conditions</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card assessment-card border-secondary" data-assessment="tapping">
                                <div class="card-body text-center position-relative">
                                    <div class="assessment-status" style="display: none;">
                                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-success">
                                            <i data-feather="check" style="width: 12px; height: 12px;"></i>
                                        </span>
                                    </div>
                                    <i data-feather="target" class="mb-3" style="width: 48px; height: 48px;"></i>
                                    <h5>Fine Motor Assessment</h5>
                                    <p class="text-muted small">Test fine motor control and dexterity</p>
                                    <span class="badge bg-secondary">Motor Skills</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card assessment-card border-info" data-assessment="speech">
                                <div class="card-body text-center position-relative">
                                    <div class="assessment-status" style="display: none;">
                                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-success">
                                            <i data-feather="check" style="width: 12px; height: 12px;"></i>
                                        </span>
                                    </div>
                                    <i data-feather="mic" class="mb-3" style="width: 48px; height: 48px;"></i>
                                    <h5>Speech Assessment</h5>
                                    <p class="text-muted small">Evaluate speech clarity and rate</p>
                                    <span class="badge bg-info">Communication</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Additional assessments for mixed conditions -->
                    <div class="row g-3 mt-2">
                        <div class="col-md-4">
                            <div class="card assessment-card border-warning" data-assessment="balance">
                                <div class="card-body text-center position-relative">
                                    <div class="assessment-status" style="display: none;">
                                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-success">
                                            <i data-feather="check" style="width: 12px; height: 12px;"></i>
                                        </span>
                                    </div>
                                    <i data-feather="crosshair" class="mb-3" style="width: 48px; height: 48px;"></i>
                                    <h5>Balance Assessment</h5>
                                    <p class="text-muted small">Test static and dynamic balance</p>
                                    <span class="badge bg-warning">Stroke Specific</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card assessment-card border-success" data-assessment="coordination">
                                <div class="card-body text-center position-relative">
                                    <div class="assessment-status" style="display: none;">
                                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-success">
                                            <i data-feather="check" style="width: 12px; height: 12px;"></i>
                                        </span>
                                    </div>
                                    <i data-feather="shuffle" class="mb-3" style="width: 48px; height: 48px;"></i>
                                    <h5>Coordination Assessment</h5>
                                    <p class="text-muted small">Evaluate limb coordination</p>
                                    <span class="badge bg-success">Stroke Specific</span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card assessment-card border-danger" data-assessment="cognitive">
                                <div class="card-body text-center position-relative">
                                    <div class="assessment-status" style="display: none;">
                                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-success">
                                            <i data-feather="check" style="width: 12px; height: 12px;"></i>
                                        </span>
                                    </div>
                                    <i data-feather="cpu" class="mb-3" style="width: 48px; height: 48px;"></i>
                                    <h5>Cognitive Assessment</h5>
                                    <p class="text-muted small">Test attention and processing</p>
                                    <span class="badge bg-danger">Stroke Specific</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- Assessment Form -->
                <form id="assessmentForm" style="display: none;">
                    <input type="hidden" id="assessment_type" name="assessment_type" value="">
                    <input type="hidden" id="measured_value" name="measured_value" value="">

                    {% if patients %}
                    <div class="mb-3">
                        <label for="patient_id" class="form-label">Select Patient</label>
                        <select class="form-control" id="patient_id" name="patient_id" required>
                            <option value="">Choose a patient...</option>
                            {% for patient in patients %}
                            <option value="{{ patient.id }}" 
                                {% if request.args.get('patient_id') == patient.id|string %}selected{% endif %}>
                                {{ patient.user.first_name }} {{ patient.user.last_name }} 
                                ({{ patient.condition.replace('_', ' ').title() }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    {% endif %}

                    <div id="assessmentInstructions" class="alert alert-info mb-4">
                        <i data-feather="info" class="me-2"></i>
                        <span id="instructionText">Select an assessment type to begin</span>
                    </div>

                    <!-- Gait Assessment Specific -->
                    <div id="gaitAssessment" class="assessment-section" style="display: none;">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="gait_cadence" class="form-label">Walking Cadence (steps/minute)</label>
                                <input type="number" class="form-control" id="gait_cadence" name="gait_cadence" 
                                       min="40" max="180" step="1" placeholder="e.g., 120" required>
                                <div class="form-text">Normal range: 100-140 steps/minute</div>
                            </div>
                            <div class="col-md-6">
                                <div class="card mt-4">
                                    <div class="card-body text-center">
                                        <button type="button" class="btn btn-outline-primary" id="measureGaitBtn">
                                            <i data-feather="clock" class="me-2"></i>
                                            Measure for 30s
                                        </button>
                                        <div id="gaitTimer" class="mt-2" style="display: none;">
                                            <span class="h4" id="gaitCountdown">30</span>
                                            <div><small class="text-muted">Count each step</small></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tapping Assessment Specific -->
                    <div id="tappingAssessment" class="assessment-section" style="display: none;">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="tapping_speed" class="form-label">Tapping Speed (taps/minute)</label>
                                <input type="number" class="form-control" id="tapping_speed" name="tapping_speed" 
                                       min="30" max="300" step="1" placeholder="e.g., 180" required>
                                <div class="form-text">Normal range: 150-250 taps/minute</div>
                            </div>
                            <div class="col-md-6">
                                <div class="card mt-4">
                                    <div class="card-body text-center">
                                        <button type="button" class="btn btn-outline-primary" id="measureTappingBtn">
                                            <i data-feather="clock" class="me-2"></i>
                                            Measure for 15s
                                        </button>
                                        <div id="tappingTimer" class="mt-2" style="display: none;">
                                            <span class="h4" id="tappingCountdown">15</span>
                                            <div><small class="text-muted">Tap spacebar rapidly</small></div>
                                            <div class="mt-2">
                                                <span class="h5">Taps: <span id="tapCount">0</span></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Upper Limb Assessment Specific -->
                    <div id="upper_limbAssessment" class="assessment-section" style="display: none;">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="upper_limb_score" class="form-label">Upper Limb Motor Score (0-66 FMA-UE)</label>
                                <input type="number" class="form-control" id="upper_limb_score" name="upper_limb_score" 
                                       min="0" max="66" step="1" placeholder="e.g., 45" required>
                                <div class="form-text">Fugl-Meyer Assessment - Upper Extremity: 0-66 scale</div>
                            </div>
                            <div class="col-md-6">
                                <div class="card mt-4">
                                    <div class="card-body">
                                        <h6>Assessment Instructions</h6>
                                        <ul class="small text-muted">
                                            <li>Shoulder/elbow/forearm movements</li>
                                            <li>Wrist and hand coordination</li>
                                            <li>Reflexes and sensation</li>
                                            <li>Speed and coordination tests</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Melodic Assessment Specific -->
                    <div id="melodicAssessment" class="assessment-section" style="display: none;">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="melodic_score" class="form-label">Melodic Intonation Score (0-20)</label>
                                <input type="number" class="form-control" id="melodic_score" name="melodic_score" 
                                       min="0" max="20" step="1" placeholder="e.g., 12" required>
                                <div class="form-text">MIT Assessment Scale: 0-20 (higher is better)</div>
                            </div>
                            <div class="col-md-6">
                                <div class="card mt-4">
                                    <div class="card-body">
                                        <h6>MIT Assessment</h6>
                                        <ul class="small text-muted">
                                            <li>Pitch accuracy in humming</li>
                                            <li>Rhythm synchronization</li>
                                            <li>Phrase repetition ability</li>
                                            <li>Vocal expression quality</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Speech Assessment Specific -->
                    <div id="speechAssessment" class="assessment-section" style="display: none;">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="speech_rate" class="form-label">Speech Rate (syllables/minute)</label>
                                <input type="number" class="form-control" id="speech_rate" name="speech_rate" 
                                       min="60" max="300" step="1" placeholder="e.g., 200" required>
                                <div class="form-text">Normal range: 180-220 syllables/minute</div>
                            </div>
                            <div class="col-md-6">
                                <div class="card mt-4">
                                    <div class="card-body">
                                        <h6>Sample Text</h6>
                                        <p class="small text-muted">
                                            "The quick brown fox jumps over the lazy dog. 
                                            She sells seashells by the seashore."
                                        </p>
                                        <button type="button" class="btn btn-outline-primary btn-sm" id="measureSpeechBtn">
                                            <i data-feather="mic" class="me-2"></i>
                                            Read Aloud (30s)
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Balance Assessment Specific -->
                    <div id="balanceAssessment" class="assessment-section" style="display: none;">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="balance_score" class="form-label">Balance Score (0-56 Berg Balance Scale)</label>
                                <input type="number" class="form-control" id="balance_score" name="balance_score" 
                                       min="0" max="56" step="1" placeholder="e.g., 45" required>
                                <div class="form-text">High fall risk: &lt;45, Low fall risk: 45-56</div>
                            </div>
                            <div class="col-md-6">
                                <div class="card mt-4">
                                    <div class="card-body">
                                        <h6>Assessment Instructions</h6>
                                        <ul class="small text-muted">
                                            <li>Standing with eyes closed</li>
                                            <li>Standing on one foot</li>
                                            <li>Turning 360 degrees</li>
                                            <li>Standing with feet together</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Coordination Assessment Specific -->
                    <div id="coordinationAssessment" class="assessment-section" style="display: none;">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="coordination_time" class="form-label">Finger-to-Nose Time (seconds)</label>
                                <input type="number" class="form-control" id="coordination_time" name="coordination_time" 
                                       min="1" max="60" step="0.1" placeholder="e.g., 3.5" required>
                                <div class="form-text">Average time to complete 10 repetitions</div>
                            </div>
                            <div class="col-md-6">
                                <div class="card mt-4">
                                    <div class="card-body">
                                        <h6>Test Instructions</h6>
                                        <p class="small text-muted">
                                            Have patient touch nose then examiner's finger alternately
                                            10 times with each hand. Record average time per repetition.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Cognitive Assessment Specific -->
                    <div id="cognitiveAssessment" class="assessment-section" style="display: none;">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="cognitive_score" class="form-label">MoCA Score (0-30)</label>
                                <input type="number" class="form-control" id="cognitive_score" name="cognitive_score" 
                                       min="0" max="30" step="1" placeholder="e.g., 24" required>
                                <div class="form-text">Normal: ≥26, Mild impairment: 18-25, Severe: &lt;18</div>
                            </div>
                            <div class="col-md-6">
                                <div class="card mt-4">
                                    <div class="card-body">
                                        <h6>Montreal Cognitive Assessment</h6>
                                        <ul class="small text-muted">
                                            <li>Executive function</li>
                                            <li>Memory</li>
                                            <li>Language</li>
                                            <li>Attention & concentration</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Notes Section -->
                    <div class="mb-4" id="notesSection" style="display: none;">
                        <label for="notes" class="form-label">Assessment Notes</label>
                        <textarea class="form-control" id="notes" name="notes" rows="3" 
                                  placeholder="Any observations or additional notes about the assessment..."></textarea>
                    </div>

                    <!-- Submit Button -->
                    <div class="text-center" id="submitSection" style="display: none;">
                        <button type="button" class="btn btn-success btn-lg" id="saveAssessmentBtn">
                            <i data-feather="save" class="me-2"></i>
                            Save Baseline Assessment
                        </button>
                        <button type="button" class="btn btn-secondary btn-lg ms-2" onclick="resetForm()">
                            <i data-feather="refresh-cw" class="me-2"></i>
                            Reset
                        </button>
                    </div>
                </form>

                <!-- No Patients Message for Clinicians -->
                {% if not patients %}
                <div class="text-center py-5">
                    <i data-feather="users" class="mb-3" style="width: 64px; height: 64px; opacity: 0.5;"></i>
                    <h5 class="text-muted">No Patients Assigned</h5>
                    <p class="text-muted">You need to have patients assigned to perform baseline assessments.</p>
                    <a href="{{ url_for('clinician_dashboard') }}" class="btn btn-primary">
                        <i data-feather="arrow-left" class="me-2"></i>
                        Back to Dashboard
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
.assessment-card {
    cursor: pointer;
    transition: all 0.3s ease;
    height: 100%;
}

.assessment-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.assessment-card.selected {
    background: rgba(0, 123, 255, 0.1);
    border-color: var(--bs-primary) !important;
    border-width: 2px;
}

.assessment-section {
    background: rgba(255, 255, 255, 0.05);
    padding: 1.5rem;
    border-radius: 0.5rem;
    margin-bottom: 1rem;
}

#gaitTimer, #tappingTimer {
    background: rgba(0, 123, 255, 0.1);
    padding: 1rem;
    border-radius: 0.5rem;
}
</style>

<script>
let selectedAssessment = null;
let measurementTimer = null;
let measurementActive = false;
let tapCount = 0;
let completedAssessments = [];
// Set assessment queue based on patient condition
let assessmentQueue = ['gait', 'tapping', 'speech', 'balance', 'coordination', 'cognitive'];
let isStrokePatient = false;

// Check if selected patient is stroke patient
function updateAssessmentQueue() {
    const patientSelect = document.getElementById('patient_id');
    if (patientSelect && patientSelect.value) {
        const selectedOption = patientSelect.options[patientSelect.selectedIndex];
        const patientText = selectedOption.text;
        isStrokePatient = patientText.includes('(Stroke)');
        
        if (isStrokePatient) {
            assessmentQueue = ['gait', 'upper_limb', 'melodic', 'speech'];
            // Hide non-stroke assessments
            hideNonStrokeAssessments();
        } else {
            assessmentQueue = ['gait', 'tapping', 'speech', 'balance', 'coordination', 'cognitive'];
            // Show all assessments
            showAllAssessments();
        }
    }
}

function hideNonStrokeAssessments() {
    const nonStrokeTypes = ['tapping', 'balance', 'coordination', 'cognitive'];
    nonStrokeTypes.forEach(type => {
        const card = document.querySelector(`[data-assessment="${type}"]`);
        if (card) {
            card.style.display = 'none';
        }
    });
}

function showAllAssessments() {
    document.querySelectorAll('.assessment-card').forEach(card => {
        card.style.display = 'block';
    });
}

// Assessment type selection
document.querySelectorAll('.assessment-card').forEach(card => {
    card.addEventListener('click', function() {
        const assessmentType = this.dataset.assessment;
        selectAssessment(assessmentType);
    });
});

function selectAssessment(type) {
    // Remove previous selection
    document.querySelectorAll('.assessment-card').forEach(card => {
        card.classList.remove('selected');
    });

    // Hide all assessment sections
    document.querySelectorAll('.assessment-section').forEach(section => {
        section.style.display = 'none';
    });

    // Select new assessment
    selectedAssessment = type;
    const selectedCard = document.querySelector(`[data-assessment="${type}"]`);
    selectedCard.classList.add('selected');
    document.getElementById('assessment_type').value = type;

    // Show form and relevant sections
    document.getElementById('assessmentForm').style.display = 'block';
    document.getElementById('notesSection').style.display = 'block';
    document.getElementById('submitSection').style.display = 'block';

    // Show specific assessment section
    document.getElementById(`${type}Assessment`).style.display = 'block';

    // Update instructions
    const instructions = {
        gait: 'Walk at your normal pace for 30 seconds while counting steps, or have someone count for you.',
        tapping: 'Tap with your index finger as quickly and consistently as possible for 15 seconds.',
        speech: 'Read the sample text aloud at your normal speaking pace for 30 seconds.',
        balance: 'Perform balance tasks according to the Berg Balance Scale. Score each task 0-4.',
        coordination: 'Perform finger-to-nose test alternating between nose and examiner finger.',
        cognitive: 'Complete the Montreal Cognitive Assessment (MoCA) test with all domains.',
        upper_limb: 'Assess upper extremity motor function using the Fugl-Meyer Assessment scale.',
        melodic: 'Evaluate melodic intonation therapy capabilities through humming and phrase repetition.'
    };

    document.getElementById('instructionText').textContent = instructions[type] || 'Please follow the assessment guidelines.';

    feather.replace();
}

// Gait measurement
document.getElementById('measureGaitBtn').addEventListener('click', function() {
    if (measurementActive) return;

    measurementActive = true;
    this.disabled = true;
    document.getElementById('gaitTimer').style.display = 'block';

    let countdown = 30;
    const countdownElement = document.getElementById('gaitCountdown');

    measurementTimer = setInterval(() => {
        countdown--;
        countdownElement.textContent = countdown;

        if (countdown <= 0) {
            clearInterval(measurementTimer);
            measurementActive = false;
            document.getElementById('measureGaitBtn').disabled = false;
            document.getElementById('gaitTimer').style.display = 'none';

            // Prompt for step count
            const steps = prompt('How many steps did you count in 30 seconds?');
            if (steps && !isNaN(steps)) {
                const cadence = Math.round(steps * 2); // Convert to steps per minute
                document.getElementById('gait_cadence').value = cadence;
            }
        }
    }, 1000);
});

// Tapping measurement
document.getElementById('measureTappingBtn').addEventListener('click', function() {
    if (measurementActive) return;

    measurementActive = true;
    this.disabled = true;
    tapCount = 0;
    document.getElementById('tappingTimer').style.display = 'block';
    document.getElementById('tapCount').textContent = '0';

    let countdown = 15;
    const countdownElement = document.getElementById('tappingCountdown');

    // Add keyboard listener
    const tapHandler = (e) => {
        if (e.code === 'Space' && measurementActive) {
            e.preventDefault();
            tapCount++;
            document.getElementById('tapCount').textContent = tapCount;
        }
    };

    document.addEventListener('keydown', tapHandler);

    measurementTimer = setInterval(() => {
        countdown--;
        countdownElement.textContent = countdown;

        if (countdown <= 0) {
            clearInterval(measurementTimer);
            measurementActive = false;
            document.removeEventListener('keydown', tapHandler);
            document.getElementById('measureTappingBtn').disabled = false;
            document.getElementById('tappingTimer').style.display = 'none';

            const tapsPerMinute = Math.round(tapCount * 4); // Convert to taps per minute
            document.getElementById('tapping_speed').value = tapsPerMinute;
        }
    }, 1000);
});

// Speech measurement
document.getElementById('measureSpeechBtn').addEventListener('click', function() {
    if (measurementActive) return;

    alert('Read the sample text aloud at your normal pace for 30 seconds. Count the syllables you speak and enter the result manually.');

    const syllables = prompt('How many syllables did you speak in 30 seconds?');
    if (syllables && !isNaN(syllables)) {
        const speechRate = Math.round(syllables * 2); // Convert to syllables per minute
        document.getElementById('speech_rate').value = speechRate;
    }
});

function resetForm() {
    selectedAssessment = null;
    document.getElementById('assessmentForm').style.display = 'none';
    document.querySelectorAll('.assessment-card').forEach(card => {
        card.classList.remove('selected');
    });

    // Clear form inputs
    document.getElementById('assessmentForm').reset();

    // Stop any active measurements
    if (measurementTimer) {
        clearInterval(measurementTimer);
        measurementTimer = null;
    }
    measurementActive = false;
    tapCount = 0;

    feather.replace();
}

// Submit button click handler
document.getElementById('saveAssessmentBtn').addEventListener('click', async function() {
    console.log('Save button clicked');

    const assessmentType = document.getElementById('assessment_type').value;
    console.log('Assessment type:', assessmentType);

    if (!assessmentType) {
        alert('Please select an assessment type.');
        return;
    }

    const patientId = document.getElementById('patient_id').value;
    console.log('Patient ID:', patientId);

    if (!patientId) {
        alert('Please select a patient.');
        return;
    }

    let measuredValue;
    let inputElement;

    // Get the correct input element based on assessment type
    const inputMapping = {
        'gait': 'gait_cadence',
        'tapping': 'tapping_speed', 
        'speech': 'speech_rate',
        'balance': 'balance_score',
        'coordination': 'coordination_time',
        'cognitive': 'cognitive_score',
        'upper_limb': 'upper_limb_score',
        'melodic': 'melodic_score'
    };

    const inputId = inputMapping[assessmentType];
    console.log('Looking for input with ID:', inputId);

    if (inputId) {
        inputElement = document.getElementById(inputId);
        measuredValue = inputElement ? inputElement.value : '';
    }

    console.log('Measured value:', measuredValue);

    if (!measuredValue || isNaN(measuredValue) || parseFloat(measuredValue) <= 0) {
        alert('Please enter a valid measurement value greater than 0.');
        if (inputElement) inputElement.focus();
        return;
    }

    // Disable submit button to prevent double submission
    const submitBtn = document.getElementById('saveAssessmentBtn');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Saving...';

    try {
        // Create form data
        const formData = new FormData();
        formData.append('assessment_type', assessmentType);
        formData.append('patient_id', patientId);
        formData.append('measured_value', measuredValue);
        formData.append('notes', document.getElementById('notes').value || '');

        console.log('Sending form data:', {
            assessment_type: assessmentType,
            patient_id: patientId,
            measured_value: measuredValue,
            notes: document.getElementById('notes').value || ''
        });

        const response = await fetch('/baseline/assessment', {
            method: 'POST',
            body: formData
        });

        console.log('Response status:', response.status);
        console.log('Response ok:', response.ok);

        if (response.ok) {
            const result = await response.json();
            console.log('Response data:', result);

            if (result.success) {
                // Mark this assessment as completed
                completedAssessments.push(assessmentType);

                // Show success popup with action type (saved/updated)
                const actionText = result.action === 'updated' ? 'updated' : 'saved';
                showSuccessPopup(`${assessmentType.charAt(0).toUpperCase() + assessmentType.slice(1)} assessment ${actionText} successfully!`, assessmentType, measuredValue);

                // Reset form for next assessment
                resetCurrentAssessment();

                // Suggest next assessment
                suggestNextAssessment();
            } else {
                console.error('Server returned error:', result.message);
                alert(result.message || 'Failed to save assessment. Please try again.');
            }
        } else {
            const errorText = await response.text();
            console.error('Error response:', errorText);
            alert('Failed to save assessment. Please try again.');
        }
    } catch (error) {
        console.error('Error saving assessment:', error);
        alert('Failed to save assessment. Please try again.');
    } finally {
        // Re-enable submit button
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i data-feather="save" class="me-2"></i>Save Baseline Assessment';
        feather.replace();
    }
});

function showSuccessPopup(message, assessmentType, value) {
    // Create popup overlay
    const overlay = document.createElement('div');
    overlay.className = 'position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center';
    overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
    overlay.style.zIndex = '9999';

    // Create popup content
    const popup = document.createElement('div');
    popup.className = 'bg-white rounded shadow-lg p-4 text-center';
    popup.style.maxWidth = '400px';
    popup.style.width = '90%';

    const unit = getUnit(assessmentType);

    popup.innerHTML = `
        <div class="text-success mb-3">
            <i data-feather="check-circle" style="width: 48px; height: 48px;"></i>
        </div>
        <h5 class="text-success mb-3">Assessment Saved!</h5>
        <p class="mb-3">${message}</p>
        <div class="alert alert-info">
            <strong>${assessmentType.replace('_', ' ').toUpperCase()} Baseline:</strong> ${value} ${unit}
        </div>
        <button type="button" class="btn btn-success" onclick="closeSuccessPopup()">Continue</button>
    `;

    overlay.appendChild(popup);
    document.body.appendChild(overlay);

    // Replace feather icons
    feather.replace();

    // Store reference for removal
    window.currentPopup = overlay;
}

function closeSuccessPopup() {
    if (window.currentPopup) {
        document.body.removeChild(window.currentPopup);
        window.currentPopup = null;
    }
}

function getUnit(assessmentType) {
    const units = {
        'gait': 'steps/min',
        'tapping': 'taps/min', 
        'speech': 'syllables/min',
        'balance': '/56',
        'coordination': 'seconds',
        'cognitive': '/30',
        'upper_limb': '/66',
        'melodic': '/20'
    };
    return units[assessmentType] || '';
}

function resetCurrentAssessment() {
    // Hide all assessment sections
    document.querySelectorAll('.assessment-section').forEach(section => {
        section.style.display = 'none';
    });

    // Clear form inputs
    const currentInputs = document.querySelectorAll('.assessment-section input');
    currentInputs.forEach(input => {
        input.value = '';
        input.required = false;
    });

    // Remove selection
    document.querySelectorAll('.assessment-card').forEach(card => {
        card.classList.remove('selected');
    });

    // Clear hidden fields
    document.getElementById('assessment_type').value = '';
    document.getElementById('measured_value').value = '';

    // Hide form sections
    document.getElementById('notesSection').style.display = 'none';
    document.getElementById('submitSection').style.display = 'none';

    selectedAssessment = null;
}

function suggestNextAssessment() {
    // Find next uncompleted assessment
    const nextAssessment = assessmentQueue.find(assessment => 
        !completedAssessments.includes(assessment)
    );

    if (nextAssessment) {
        // Show suggestion popup
        setTimeout(() => {
            const continueNext = confirm(`Great! Would you like to continue with the ${nextAssessment.replace('_', ' ').toUpperCase()} assessment?`);

            if (continueNext) {
                selectAssessment(nextAssessment);
            }
        }, 500);
    } else {
        // All assessments completed
        setTimeout(() => {
            const goToDashboard = confirm('All baseline assessments completed! Would you like to return to the dashboard?');

            if (goToDashboard) {
                window.location.href = '/clinician/dashboard';
            }
        }, 500);
    }
}

// Load existing assessments for selected patient
async function loadExistingAssessments(patientId) {
    if (!patientId) return;

    try {
        const response = await fetch(`/api/patient/${patientId}/assessments`);
        if (response.ok) {
            const assessments = await response.json();

            // Mark assessments as completed and show check marks
            assessments.forEach(assessment => {
                const card = document.querySelector(`[data-assessment="${assessment.assessment_type}"]`);
                if (card) {
                    const statusBadge = card.querySelector('.assessment-status');
                    if (statusBadge) {
                        statusBadge.style.display = 'block';
                    }

                    // Add to completed assessments if not already there
                    if (!completedAssessments.includes(assessment.assessment_type)) {
                        completedAssessments.push(assessment.assessment_type);
                    }
                }
            });

            feather.replace();
        }
    } catch (error) {
        console.error('Error loading existing assessments:', error);
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    feather.replace();

    // Prevent dropdown.js from interfering with the patient select
    const patientSelect = document.getElementById('patient_id');
    if (patientSelect) {
        patientSelect.classList.remove('form-select');
        patientSelect.classList.add('form-control');

        // Load existing assessments when patient is selected
        patientSelect.addEventListener('change', function() {
            const patientId = this.value;
            if (patientId) {
                loadExistingAssessments(patientId);
                updateAssessmentQueue(); // Update available assessments based on patient condition
            } else {
                // Clear completed assessments when no patient selected
                completedAssessments = [];
                document.querySelectorAll('.assessment-status').forEach(status => {
                    status.style.display = 'none';
                });
                showAllAssessments(); // Show all assessments when no patient selected
            }
        });

        // Load assessments if patient is pre-selected (from URL parameter)
        if (patientSelect.value) {
            loadExistingAssessments(patientSelect.value);
            updateAssessmentQueue(); // Update assessments for pre-selected patient
        }
    }
});
</script>
{% endblock %}