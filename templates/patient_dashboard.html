{% extends "base.html" %}

{% block title %}Patient Dashboard - NeuroBeat{% endblock %}

{% block content %}
<div class="row">
    <!-- Welcome Section -->
    <div class="col-12 mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2>Welcome back, {{ user.first_name }}!</h2>
                <p class="text-muted">{{ patient_profile.condition.replace('_', ' ').title() }} Recovery Program</p>
            </div>
            <div>
                <!-- Removed Start Gait Trainer button -->
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="col-12 mb-4">
        <div class="row g-4">
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body text-center">
                        <i data-feather="activity" class="mb-2" style="width: 32px; height: 32px;"></i>
                        <h4>{{ total_sessions }}</h4>
                        <p class="text-muted mb-0">Total Sessions</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body text-center">
                        <i data-feather="target" class="mb-2" style="width: 32px; height: 32px;"></i>
                        <h4>{{ avg_accuracy }}%</h4>
                        <p class="text-muted mb-0">Avg Accuracy</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body text-center">
                        <i data-feather="trending-up" class="mb-2" style="width: 32px; height: 32px;"></i>
                        <h4>{{ patient_profile.baseline_cadence or 'N/A' }}</h4>
                        <p class="text-muted mb-0">Baseline BPM</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body text-center">
                        <i data-feather="flag" class="mb-2" style="width: 32px; height: 32px;"></i>
                        <h4>{{ patient_profile.target_cadence or 'N/A' }}</h4>
                        <p class="text-muted mb-0">Target BPM</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="col-lg-8">
        <!-- Therapy Modules -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i data-feather="play-circle" class="me-2"></i>
                    {% if patient_profile.condition == 'stroke' %}Stroke Rehabilitation Modules{% else %}Therapy Modules{% endif %}
                </h5>
            </div>
            <div class="card-body">
                {% if patient_profile.condition == 'stroke' %}
                <!-- Stroke-specific therapy modules -->
                <div class="row g-3">
                    <!-- Gait Training (RAS) -->
                    <div class="col-md-6">
                        <div class="card border-primary h-100">
                            <div class="card-body text-center">
                                <i data-feather="activity" class="mb-3" style="width: 48px; height: 48px; color: #0d6efd;"></i>
                                <h5>Gait Training (RAS)</h5>
                                <p class="text-muted">Rhythmic Auditory Stimulation for walking recovery</p>
                                <small class="text-info">Recommended BPM: 40-60</small>
                                <br>
                                <button type="button" class="btn btn-primary mt-2" onclick="startStrokeSession('gait_trainer')">
                                    Start Session
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Upper Limb Motor -->
                    <div class="col-md-6">
                        <div class="card border-warning h-100">
                            <div class="card-body text-center">
                                <i data-feather="move" class="mb-3" style="width: 48px; height: 48px; color: #ffc107;"></i>
                                <h5>Upper Limb Training</h5>
                                <p class="text-muted">Percussion exercises for arm coordination</p>
                                <small class="text-warning">Focus: {{ patient_profile.stroke_affected_side or 'Both' }} side</small>
                                <br>
                                <button type="button" class="btn btn-warning mt-2" onclick="startStrokeSession('upper_limb_motor')">
                                    Start Session
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Melodic Intonation Therapy -->
                    <div class="col-md-6">
                        <div class="card border-success h-100">
                            <div class="card-body text-center">
                                <i data-feather="music" class="mb-3" style="width: 48px; height: 48px; color: #198754;"></i>
                                <h5>Melodic Intonation</h5>
                                <p class="text-muted">Singing therapy for speech recovery</p>
                                <small class="text-success">For: {{ patient_profile.aphasia_type or 'Speech' }} improvement</small>
                                <br>
                                <button type="button" class="btn btn-success mt-2" onclick="startStrokeSession('melodic_intonation')">
                                    Start Session
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Speech Rhythm -->
                    <div class="col-md-6">
                        <div class="card border-info h-100">
                            <div class="card-body text-center">
                                <i data-feather="mic" class="mb-3" style="width: 48px; height: 48px; color: #0dcaf0;"></i>
                                <h5>Speech Rhythm</h5>
                                <p class="text-muted">Syllable timing and articulation practice</p>
                                <small class="text-info">Recommended BPM: 50-90</small>
                                <br>
                                <button type="button" class="btn btn-info mt-2" onclick="startStrokeSession('speech_rhythm')">
                                    Start Session
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Cognitive Training -->
                    <div class="col-lg-12">
                        <div class="card border-secondary h-100">
                            <div class="card-body text-center">
                                <i data-feather="cpu" class="mb-3" style="width: 48px; height: 48px; color: #6c757d;"></i>
                                <h5>Cognitive Rhythm Training</h5>
                                <p class="text-muted">Attention, memory, and sequencing exercises with music</p>
                                <small class="text-secondary">Status: {{ patient_profile.cognitive_status or 'Normal' }}</small>
                                <br>
                                <button type="button" class="btn btn-secondary mt-2" onclick="startStrokeSession('cognitive_rhythm')">
                                    Start Session
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% else %}
                <!-- Standard therapy modules for Parkinson's -->
                <div class="row g-3">
                    <!-- Gait Trainer -->
                    <div class="col-md-6">
                        <div class="card border-primary h-100">
                            <div class="card-body text-center">
                                <i data-feather="activity" class="mb-3" style="width: 48px; height: 48px; color: #0d6efd;"></i>
                                <h5>Gait Trainer</h5>
                                <p class="text-muted">Improve walking rhythm and balance with musical cues</p>
                                <button type="button" class="btn btn-primary" onclick="startSession('gait_trainer')">
                                    Start Session
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Speech Rhythm -->
                    <div class="col-md-6">
                        <div class="card border-success h-100">
                            <div class="card-body text-center">
                                <i data-feather="mic" class="mb-3" style="width: 48px; height: 48px; color: #198754;"></i>
                                <h5>Speech Rhythm</h5>
                                <p class="text-muted">Practice speech timing and articulation</p>
                                <button type="button" class="btn btn-success" onclick="startSession('speech_rhythm')">
                                    Start Session
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Finger Tapping -->
                    <div class="col-md-6">
                        <div class="card border-warning h-100">
                            <div class="card-body text-center">
                                <i data-feather="move" class="mb-3" style="width: 48px; height: 48px; color: #ffc107;"></i>
                                <h5>Finger Tapping</h5>
                                <p class="text-muted">Enhance fine motor control and coordination</p>
                                <button type="button" class="btn btn-warning" onclick="startSession('finger_tapping')">
                                    Start Session
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Balance Training -->
                    <div class="col-md-6">
                        <div class="card border-info h-100">
                            <div class="card-body text-center">
                                <i data-feather="target" class="mb-3" style="width: 48px; height: 48px; color: #0dcaf0;"></i>
                                <h5>Balance Training</h5>
                                <p class="text-muted">Improve stability with rhythmic exercises</p>
                                <button type="button" class="btn btn-info" onclick="startSession('balance_training')">
                                    Start Session
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Recent Sessions -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i data-feather="clock" class="me-2"></i>
                    Recent Sessions
                </h5>
            </div>
            <div class="card-body">
                {% if recent_sessions %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>Duration</th>
                                    <th>Accuracy</th>
                                    <th>BPM Range</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for session in recent_sessions %}
                                <tr>
                                    <td>{{ session.start_time.strftime('%m/%d/%Y %I:%M %p') }}</td>
                                    <td>
                                        <span class="badge bg-primary">{{ session.session_type.replace('_', ' ').title() }}</span>
                                    </td>
                                    <td>{{ (session.duration_seconds // 60) if session.duration_seconds else 'N/A' }} min</td>
                                    <td>
                                        {% if session.accuracy_score %}
                                            <span class="badge {% if session.accuracy_score >= 80 %}bg-success{% elif session.accuracy_score >= 60 %}bg-warning{% else %}bg-danger{% endif %}">
                                                {{ session.accuracy_score|round|int }}%
                                            </span>
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </td>
                                    <td>{{ session.initial_bpm|round|int }} - {{ session.final_bpm|round|int if session.final_bpm else session.initial_bpm|round|int }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i data-feather="calendar" class="mb-3" style="width: 48px; height: 48px; opacity: 0.5;"></i>
                        <p class="text-muted">No sessions completed yet. Start your first therapy session!</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Quick Actions -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i data-feather="zap" class="me-2"></i>
                    Quick Actions
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">

                    <a href="{{ url_for('progress_view', patient_id=patient_profile.id) }}" class="btn btn-outline-info">
                        <i data-feather="bar-chart-2" class="me-2"></i>
                        View Progress
                    </a>
                </div>
            </div>
        </div>

        <!-- Assessment Parameters Window - Only show if patient has parameters needing practice -->
        {% if patient_profile.assessments %}
            {% set has_abnormal_params = [] %}
            {% for assessment in patient_profile.assessments %}
                {% if assessment.assessment_type == 'gait' %}
                    {% set is_normal = assessment.measured_value >= 100 and assessment.measured_value <= 140 %}
                {% elif assessment.assessment_type == 'upper_limb' %}
                    {% set is_normal = assessment.measured_value >= 50 %}
                {% elif assessment.assessment_type == 'melodic' %}
                    {% set is_normal = assessment.measured_value >= 15 %}
                {% elif assessment.assessment_type == 'speech' %}
                    {% set is_normal = assessment.measured_value >= 180 and assessment.measured_value <= 220 %}
                {% elif assessment.assessment_type == 'tapping' %}
                    {% set is_normal = assessment.measured_value >= 150 and assessment.measured_value <= 250 %}
                {% elif assessment.assessment_type == 'balance' %}
                    {% set is_normal = assessment.measured_value >= 45 %}
                {% elif assessment.assessment_type == 'coordination' %}
                    {% set is_normal = assessment.measured_value >= 1 and assessment.measured_value <= 3 %}
                {% elif assessment.assessment_type == 'cognitive' %}
                    {% set is_normal = assessment.measured_value >= 26 %}
                {% else %}
                    {% set is_normal = true %}
                {% endif %}
                {% if not is_normal %}
                    {% if has_abnormal_params.append(assessment) %}{% endif %}
                {% endif %}
            {% endfor %}

            {% if has_abnormal_params %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i data-feather="alert-triangle" class="me-2 text-warning"></i>
                        Parameters Needing Practice
                    </h5>
                    <small class="text-muted">Focus on these areas during your therapy sessions</small>
                </div>
                <div class="card-body">
                    {% for assessment in patient_profile.assessments %}
                        {% if assessment.assessment_type == 'gait' %}
                            {% set normal_range = "100-140 steps/min" %}
                            {% set is_normal = assessment.measured_value >= 100 and assessment.measured_value <= 140 %}
                        {% elif assessment.assessment_type == 'upper_limb' %}
                            {% set normal_range = "50-66 (normal function)" %}
                            {% set is_normal = assessment.measured_value >= 50 %}
                        {% elif assessment.assessment_type == 'melodic' %}
                            {% set normal_range = "15-20 (good response)" %}
                            {% set is_normal = assessment.measured_value >= 15 %}
                        {% elif assessment.assessment_type == 'speech' %}
                            {% set normal_range = "180-220 syllables/min" %}
                            {% set is_normal = assessment.measured_value >= 180 and assessment.measured_value <= 220 %}
                        {% elif assessment.assessment_type == 'tapping' %}
                            {% set normal_range = "150-250 taps/min" %}
                            {% set is_normal = assessment.measured_value >= 150 and assessment.measured_value <= 250 %}
                        {% elif assessment.assessment_type == 'balance' %}
                            {% set normal_range = "45-56 (low fall risk)" %}
                            {% set is_normal = assessment.measured_value >= 45 %}
                        {% elif assessment.assessment_type == 'coordination' %}
                            {% set normal_range = "1-3 sec (normal)" %}
                            {% set is_normal = assessment.measured_value >= 1 and assessment.measured_value <= 3 %}
                        {% elif assessment.assessment_type == 'cognitive' %}
                            {% set normal_range = "26-30 (normal)" %}
                            {% set is_normal = assessment.measured_value >= 26 %}
                        {% else %}
                            {% set normal_range = "N/A" %}
                            {% set is_normal = true %}
                        {% endif %}

                        {% if not is_normal %}
                        <div class="assessment-param mb-3 p-3 border border-warning rounded bg-light">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div>
                                    <strong class="text-warning">{{ assessment.assessment_type.replace('_', ' ').title() }}</strong>
                                    <div class="text-dark small">
                                        <span class="text-dark">Your Score: {{ assessment.measured_value|round(1) }}
                                        {% if assessment.assessment_type == 'gait' %} steps/min
                                        {% elif assessment.assessment_type == 'upper_limb' %}/66</span>
                                        {% elif assessment.assessment_type == 'melodic' %}/20
                                        {% elif assessment.assessment_type == 'speech' %} syllables/min
                                        {% elif assessment.assessment_type == 'tapping' %} taps/min
                                        {% elif assessment.assessment_type == 'balance' %}/56
                                        {% elif assessment.assessment_type == 'coordination' %} sec/rep
                                        {% elif assessment.assessment_type == 'cognitive' %}/30
                                        {% endif %}
                                        <br><span class="text-dark">Normal Range: {{ normal_range }}</span>
                                        {% if patient_profile.baseline_cadence and assessment.assessment_type == 'gait' %}
                                            <br><span class="text-dark">Target BPM: {{ patient_profile.target_cadence|round|int if patient_profile.target_cadence else (patient_profile.baseline_cadence * 1.1)|round|int }}</span>
                                        {% elif patient_profile.baseline_tapping_speed and assessment.assessment_type == 'tapping' %}
                                            <br><span class="text-dark">Target Speed: {{ (patient_profile.baseline_tapping_speed * 1.15)|round|int }} taps/min</span>
                                        {% elif patient_profile.baseline_speech_rate and assessment.assessment_type == 'speech' %}
                                            <br><span class="text-dark">Target Rate: {{ patient_profile.target_speech_rate|round|int if patient_profile.target_speech_rate else (patient_profile.baseline_speech_rate * 1.15)|round|int }} syllables/min</span>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="text-end">
                                    <span class="badge bg-warning">Needs Practice</span>
                                    {% if assessment.assessment_type == 'gait' and patient_profile.baseline_cadence %}
                                        <br><small class="text-muted mt-1">{{ ((patient_profile.baseline_cadence - 100) / 40 * 100)|round|int if patient_profile.baseline_cadence < 100 else 0 }}% below target</small>
                                    {% elif assessment.assessment_type == 'upper_limb' and assessment.measured_value < 50 %}
                                        <br><small class="text-muted mt-1">{{ ((50 - assessment.measured_value) / 50 * 100)|round|int }}% below normal</small>
                                    {% elif assessment.assessment_type == 'speech' and patient_profile.baseline_speech_rate %}
                                        <br><small class="text-muted mt-1">{{ ((180 - patient_profile.baseline_speech_rate) / 40 * 100)|round|int if patient_profile.baseline_speech_rate < 180 else 0 }}% below target</small>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="p-2 bg-warning bg-opacity-10 rounded">
                                <small class="text-dark">
                                    <i data-feather="target" style="width: 14px; height: 14px;"></i>
                                    <strong>Clinician Recommendations:</strong>
                                    {% if assessment.assessment_type == 'gait' %}
                                        Focus on gait training sessions to improve walking rhythm and cadence. 
                                        {% if patient_profile.baseline_cadence %}
                                            Start at {{ patient_profile.baseline_cadence|round|int }} BPM and gradually increase to {{ patient_profile.target_cadence|round|int if patient_profile.target_cadence else (patient_profile.baseline_cadence * 1.1)|round|int }} BPM.
                                        {% endif %}
                                        {% if patient_profile.condition == 'stroke' and patient_profile.stroke_affected_side %}
                                            Focus on {{ patient_profile.stroke_affected_side }} side compensation techniques.
                                        {% endif %}
                                    {% elif assessment.assessment_type == 'upper_limb' %}
                                        Practice upper limb motor exercises to improve arm and hand coordination.
                                        {% if patient_profile.condition == 'stroke' and patient_profile.stroke_affected_side %}
                                            Concentrate on {{ patient_profile.stroke_affected_side }} side rehabilitation with bilateral coordination exercises.
                                        {% endif %}
                                        Target improvement to 50+ on Fugl-Meyer scale.
                                    {% elif assessment.assessment_type == 'melodic' %}
                                        Work on melodic intonation therapy to enhance speech through singing exercises.
                                        {% if patient_profile.aphasia_type and patient_profile.aphasia_type != 'none' %}
                                            Specialized protocols for {{ patient_profile.aphasia_type }}'s aphasia rehabilitation.
                                        {% endif %}
                                        Target score improvement to 15+ for effective communication.
                                    {% elif assessment.assessment_type == 'speech' %}
                                        Practice speech rhythm exercises to improve articulation and speaking rate.
                                        {% if patient_profile.dysarthria_severity and patient_profile.dysarthria_severity != 'none' %}
                                            Focus on {{ patient_profile.dysarthria_severity }} dysarthria management techniques.
                                        {% endif %}
                                        {% if patient_profile.baseline_speech_rate %}
                                            Work toward {{ patient_profile.target_speech_rate|round|int if patient_profile.target_speech_rate else (patient_profile.baseline_speech_rate * 1.15)|round|int }} syllables/min.
                                        {% endif %}
                                    {% elif assessment.assessment_type == 'tapping' %}
                                        Work on fine motor control exercises to improve finger dexterity.
                                        {% if patient_profile.baseline_tapping_speed %}
                                            Progress from {{ patient_profile.baseline_tapping_speed|round|int }} to {{ (patient_profile.baseline_tapping_speed * 1.15)|round|int }} taps/min.
                                        {% endif %}
                                        Target normal range of 150-250 taps/min.
                                    {% elif assessment.assessment_type == 'balance' %}
                                        Focus on balance training to reduce fall risk and improve stability.
                                        {% if patient_profile.condition == 'stroke' and patient_profile.motor_impairment_level %}
                                            Adapt exercises for {{ patient_profile.motor_impairment_level }} motor impairment level.
                                        {% endif %}
                                        Target Berg Balance Scale score of 45+ for low fall risk.
                                    {% elif assessment.assessment_type == 'coordination' %}
                                        Practice coordination exercises to improve limb movement control.
                                        Target completion time of 1-3 seconds per repetition.
                                    {% elif assessment.assessment_type == 'cognitive' %}
                                        Engage in cognitive rhythm training to improve attention and processing.
                                        {% if patient_profile.cognitive_status and patient_profile.cognitive_status != 'normal' %}
                                            Specialized protocols for {{ patient_profile.cognitive_status.replace('_', ' ') }}.
                                        {% endif %}
                                        Target MoCA score improvement to 26+ for normal cognitive function.
                                    {% endif %}
                                </small>
                            </div>
                            {% if assessment.notes %}
                                <div class="mt-2 p-2 bg-info bg-opacity-10 rounded">
                                    <small class="text-info">
                                        <i data-feather="info" style="width: 14px; height: 14px;"></i>
                                        <strong>Clinician Notes:</strong> {{ assessment.notes }}
                                    </small>
                                </div>
                            {% endif %}
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        {% endif %}

        
    </div>
</div>

<script>
async function startSession(sessionType) {
    try {
        // Use baseline BPM if available, otherwise default values
        let initialBpm = 60;
        let targetBpm = 70;
        
        {% if patient_profile.baseline_cadence %}
            initialBpm = {{ patient_profile.baseline_cadence|round|int }};
            targetBpm = {{ patient_profile.target_cadence|round|int if patient_profile.target_cadence else (patient_profile.baseline_cadence * 1.1)|round|int }};
        {% endif %}

        const response = await fetch('/session/start', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                session_type: sessionType,
                initial_bpm: initialBpm,
                target_bpm: targetBpm
            })
        });

        if (response.ok) {
            const data = await response.json();
            window.location.href = `/session/${data.session_id}`;
        } else {
            alert('Failed to start session. Please try again.');
        }
    } catch (error) {
        console.error('Error starting session:', error);
        alert('Failed to start session. Please try again.');
    }
}

async function startStrokeSession(sessionType) {
    try {
        // Use baseline BPM if available, otherwise use optimal defaults
        let defaultBpm = 60;
        let targetBpm = 65;
        let affectedLimb = null;
        let cognitiveLevel = 1;

        // Check if we have baseline assessments to use
        {% if patient_profile.baseline_cadence %}
            if (sessionType === 'gait_trainer') {
                defaultBpm = {{ patient_profile.baseline_cadence|round|int }};
                targetBpm = {{ patient_profile.target_cadence|round|int if patient_profile.target_cadence else (patient_profile.baseline_cadence * 1.05)|round|int }};
            }
        {% endif %}
        
        {% if patient_profile.baseline_tapping_speed %}
            if (sessionType === 'upper_limb_motor') {
                defaultBpm = {{ (patient_profile.baseline_tapping_speed / 4)|round|int }}; // Convert taps/min to BPM
                targetBpm = defaultBpm + 5;
            }
        {% endif %}
        
        {% if patient_profile.baseline_speech_rate %}
            if (sessionType === 'melodic_intonation' || sessionType === 'speech_rhythm') {
                defaultBpm = {{ (patient_profile.baseline_speech_rate / 3)|round|int }}; // Convert syllables/min to BPM
                targetBpm = defaultBpm + 5;
            }
        {% endif %}

        // Set optimal BPM based on session type if no baseline available
        if (!defaultBpm || defaultBpm === 60) {
            if (sessionType === 'gait_trainer') {
                defaultBpm = 50;
            } else if (sessionType === 'upper_limb_motor') {
                defaultBpm = 55;
            } else if (sessionType === 'melodic_intonation' || sessionType === 'speech_rhythm') {
                defaultBpm = 70;
            } else if (sessionType === 'cognitive_rhythm') {
                defaultBpm = 65;
            }
            targetBpm = defaultBpm + 5;
        }

        // Get session-specific parameters
        if (sessionType === 'upper_limb_motor') {
            affectedLimb = '{{ patient_profile.stroke_affected_side or "affected" }}';
        } else if (sessionType === 'cognitive_rhythm') {
            cognitiveLevel = 2; // Default cognitive level
        }

        const sessionData = {
            session_type: sessionType,
            initial_bpm: defaultBpm,
            target_bpm: targetBpm,
            affected_limb: affectedLimb,
            cognitive_load_level: cognitiveLevel
        };

        const response = await fetch('/session/start', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(sessionData)
        });

        if (response.ok) {
            const data = await response.json();

            if (data.beat_url) {
                console.log('Custom therapeutic beat generated for session');
            }

            window.location.href = `/session/${data.session_id}`;
        } else {
            alert('Failed to start session. Please try again.');
        }
    } catch (error) {
        console.error('Error starting stroke session:', error);
        alert('Failed to start session. Please try again.');
    }
}
</script>
{% endblock %}